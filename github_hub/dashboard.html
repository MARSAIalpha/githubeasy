<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>GitHub Hub - Neural Network Bridge</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Round"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              cyber: {
                black: "#050505",
                dark: "#0a0a0f",
                panel: "#121218",
                border: "#2a2a35",
                cyan: "#00f0ff",
                green: "#39ff14",
                magenta: "#ff00aa",
                dim: "rgba(0, 240, 255, 0.1)",
              },
            },
            fontFamily: {
              display: ["Space Grotesk", "sans-serif"],
              mono: ["JetBrains Mono", "monospace"],
            },
            boxShadow: {
              "neon-cyan":
                "0 0 10px rgba(0, 240, 255, 0.3), 0 0 20px rgba(0, 240, 255, 0.1)",
              "neon-green": "0 0 10px rgba(57, 255, 20, 0.3)",
              "neon-magenta": "0 0 10px rgba(255, 0, 170, 0.3)",
            },
            animation: {
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
              glitch: "glitch 1s linear infinite",
              scanline: "scanline 8s linear infinite",
            },
            keyframes: {
              scanline: {
                "0%": { transform: "translateY(-100%)" },
                "100%": { transform: "translateY(100%)" },
              },
            },
          },
        },
      };
    </script>

    <style>
      /* Base Cyberpunk Styles */
      body {
        background-color: #050505;
        color: #e0e0e0;
        overflow: hidden; /* App-like feel */
      }

      /* Scanline Overlay */
      .scanlines::before {
        content: " ";
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background:
          linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
          linear-gradient(
            90deg,
            rgba(255, 0, 0, 0.06),
            rgba(0, 255, 0, 0.02),
            rgba(0, 0, 255, 0.06)
          );
        z-index: 2;
        background-size:
          100% 2px,
          3px 100%;
        pointer-events: none;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #0a0a0f;
      }
      ::-webkit-scrollbar-thumb {
        background: #2a2a35;
        border-radius: 0;
        border: 1px solid #00f0ff;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #00f0ff;
        box-shadow: 0 0 10px #00f0ff;
      }

      /* Neon Borders */
      .neon-border {
        position: relative;
        border: 1px solid #2a2a35;
      }
      .neon-border:hover {
        border-color: #00f0ff;
        box-shadow: 0 0 15px rgba(0, 240, 255, 0.2);
      }

      /* Glitch Effect on Hover text */
      .hover-glitch:hover {
        text-shadow:
          2px 0 #ff00aa,
          -2px 0 #00f0ff;
      }

      /* Utility */
      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .text-neon-cyan {
        color: #00f0ff;
        text-shadow: 0 0 5px rgba(0, 240, 255, 0.5);
      }
      .text-neon-green {
        color: #39ff14;
        text-shadow: 0 0 5px rgba(57, 255, 20, 0.5);
      }

      /* Floating Window */
      .floating-window {
        position: fixed;
        background: rgba(18, 18, 24, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid #00f0ff;
        box-shadow: 0 0 20px rgba(0, 240, 255, 0.15);
        display: none;
        flex-direction: column;
        z-index: 50;
        min-width: 320px;
        border-radius: 4px;
      }
      .floating-window.active {
        display: flex;
      }
      .window-header {
        background: rgba(0, 240, 255, 0.1);
        border-bottom: 1px solid #00f0ff;
        padding: 8px 12px;
        cursor: grab;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .window-title {
        font-family: "JetBrains Mono", monospace;
        font-size: 0.8rem;
        color: #00f0ff;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* Sidebar Item */
      .category-item {
        transition: all 0.2s;
        border-left: 2px solid transparent;
      }
      .category-item:hover {
        background: rgba(0, 240, 255, 0.05);
        border-left-color: #00f0ff;
        padding-left: 12px;
        color: #00f0ff;
      }
      .category-item.active {
        background: rgba(0, 240, 255, 0.1);
        border-left-color: #00f0ff;
        color: #00f0ff;
        box-shadow: 0 0 15px rgba(0, 240, 255, 0.1) inset;
      }

      /* Markdown Content */
      .markdown-content h1,
      .markdown-content h2,
      .markdown-content h3 {
        color: #00f0ff;
        margin-top: 1em;
      }
      .markdown-content code {
        color: #39ff14;
        background: #0a0a0f;
        padding: 2px 4px;
        font-family: "JetBrains Mono";
      }
      .markdown-content pre {
        background: #0a0a0f;
        padding: 1em;
        border: 1px solid #2a2a35;
        overflow-x: auto;
      }

      /* Modal */
      .modal {
        background: rgba(5, 5, 5, 0.9);
        backdrop-filter: blur(5px);
      }
      .modal-content {
        background: #121218;
        border: 1px solid #00f0ff;
        box-shadow: 0 0 30px rgba(0, 240, 255, 0.2);
      }

      /* Progress Bar */
      .cyber-progress-container {
        background: #0a0a0f;
        border: 1px solid #2a2a35;
        height: 8px;
        width: 100%;
        position: relative;
      }
      .cyber-progress-bar {
        background: #00f0ff;
        height: 100%;
        width: 0%;
        box-shadow: 0 0 10px #00f0ff;
        transition: width 0.3s;
      }
      /* Custom Window Controls - Large & Pixelated */
      .win-ctrl {
        width: 24px;
        height: 24px;
        border: 2px solid #333;
        background: #000;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.1s;
        image-rendering: pixelated;
      }
      .win-ctrl:hover {
        border-color: #fff;
        transform: scale(1.1);
      }
      .win-ctrl.min::after {
        content: "";
        width: 8px;
        height: 2px;
        background: #ffcc00;
        box-shadow: 0 0 5px #ffcc00;
      }
      .win-ctrl.close::after {
        content: "√ó";
        color: #ff00aa;
        font-family: "JetBrains Mono";
        font-size: 20px;
        line-height: 1;
        font-weight: bold;
        text-shadow: 0 0 5px #ff00aa;
      }
      .win-ctrl.close:hover {
        background: rgba(255, 0, 170, 0.2);
        border-color: #ff00aa;
      }
      .win-ctrl.min:hover {
        background: rgba(255, 204, 0, 0.2);
        border-color: #ffcc00;
      }


      /* Hover Tooltip */
      #hover-summary-tooltip {
          position: fixed;
          background: rgba(5, 5, 8, 0.98);
          border: 1px solid #00f0ff;
          padding: 12px;
          z-index: 9999;
          pointer-events: none;
          display: none;
          width: 300px;
          box-shadow: 0 0 30px rgba(0, 240, 255, 0.2);
          backdrop-filter: blur(10px);
          font-family: 'JetBrains Mono', monospace;
      }
      #hover-summary-tooltip::before {
          content: "";
          position: absolute;
          top: 0; left: 0; right: 0; height: 1px;
          background: linear-gradient(90deg, transparent, #00f0ff, transparent);
      }
    </style>
  </head>

  <body
    class="font-display antialiased h-screen flex flex-col selection:bg-cyber-cyan selection:text-black"
  >
    <!-- Background Matrix Rain Effect (Simple CSS/Canvas placeholder could go here) -->
    <div
      class="fixed inset-0 pointer-events-none z-0 opacity-20"
      style="
        background-image: radial-gradient(
          circle at 50% 50%,
          #121218 0%,
          #050505 100%
        );
      "
    ></div>

    <!-- Header -->
    <header
      class="relative z-10 bg-cyber-dark/90 border-b border-cyber-border h-16 flex items-center justify-between px-6 backdrop-blur"
    >
      <div class="flex items-center gap-4">
        <button
          class="text-cyber-cyan hover:text-white transition-colors"
          onclick="toggleSidebar()"
        >
          <span class="material-icons-round text-2xl">menu</span>
        </button>
        <div
          class="flex items-center gap-2 group cursor-pointer"
          onclick="switchTab('view-dashboard')"
        >
          <span
            class="material-icons-round text-cyber-cyan text-2xl group-hover:animate-pulse"
            >terminal</span
          >
          <span
            class="font-mono font-bold text-xl tracking-tighter text-white group-hover:text-cyber-cyan transition-colors"
            >GITHUB_HUB<span class="animate-pulse">_</span></span
          >
        </div>

        <!-- Header Stats (Mini) -->
        <div
          class="hidden md:flex items-center gap-6 ml-8 border-l border-cyber-border pl-6"
        >
          <div class="flex flex-col">
            <span
              class="text-[10px] font-mono text-gray-500 uppercase tracking-widest"
              >System Status</span
            >
            <span
              class="text-xs font-mono text-cyber-green flex items-center gap-1"
            >
              <span
                class="w-2 h-2 bg-cyber-green rounded-full animate-pulse"
              ></span>
              ONLINE
            </span>
          </div>
          <!-- Progress Bar Area -->
          <div id="progress-container" style="display: none; width: 200px">
            <div
              class="flex justify-between text-[10px] font-mono text-cyber-cyan mb-1"
            >
              <span id="progress-current">PROCESSING</span>
              <span id="progress-text">0/0</span>
            </div>
            <div class="cyber-progress-container">
              <div id="progress-bar" class="cyber-progress-bar"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-4">
        <!-- Action Buttons -->
        <div
          class="flex items-center bg-cyber-panel border border-cyber-border rounded-sm p-1"
        >
          <button
            onclick="switchTab('view-search')"
            class="px-3 py-1 hover:bg-cyber-dim rounded-sm transition-colors text-gray-400 hover:text-cyber-cyan"
            title="Neural Search"
          >
            <span class="material-icons-round text-lg">search</span>
          </button>
          <button
            onclick="toggleManageMode()"
            id="btn-manage"
            class="px-3 py-1 hover:bg-cyber-dim rounded-sm transition-colors text-gray-400 hover:text-cyber-magenta"
            title="Delete Mode"
          >
            <span class="material-icons-round text-lg">delete_sweep</span>
          </button>
          <button
            onclick="toggleWindow('agent-window')"
            class="px-3 py-1 hover:bg-cyber-dim rounded-sm transition-colors text-gray-400 hover:text-cyber-green"
            title="Agent Monitor"
          >
            <span class="material-icons-round text-lg">smart_toy</span>
          </button>
          <button
            onclick="toggleWindow('terminal-window')"
            class="px-3 py-1 hover:bg-cyber-dim rounded-sm transition-colors text-gray-400 hover:text-white"
            title="System Logs"
          >
            <span class="material-icons-round text-lg">dvr</span>
          </button>
        </div>

        <button
          onclick="startScan()"
          class="bg-cyber-cyan hover:bg-cyan-400 text-black font-mono font-bold text-xs px-5 py-2 rounded-sm shadow-neon-cyan flex items-center gap-2 transition-all active:scale-95"
        >
          <span class="material-icons-round text-sm">radar</span> INIT_SCAN
        </button>

        <button
          onclick="openSettings()"
          class="text-gray-500 hover:text-white transition-colors"
        >
          <span class="material-icons-round">settings</span>
        </button>
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative z-10">
      <!-- Sidebar -->
      <aside
        id="main-sidebar"
        class="w-64 bg-cyber-black border-r border-cyber-border flex flex-col transition-all duration-300 transform translate-x-0"
      >
        <!-- Sidebar Stats -->
        <div class="p-6 border-b border-cyber-border bg-cyber-panel/50">
          <div class="grid grid-cols-2 gap-4 mb-4">
            <div
              class="bg-cyber-black p-3 border border-cyber-border rounded-sm neon-border group"
            >
              <div
                class="text-2xl font-mono font-bold text-white group-hover:text-cyber-cyan transition-colors"
                id="sidebar-stat-total"
              >
                0
              </div>
              <div
                class="text-[10px] text-gray-500 uppercase tracking-widest mt-1"
              >
                Total Nodes
              </div>
            </div>
            <div
              class="bg-cyber-black p-3 border border-cyber-border rounded-sm neon-border group"
            >
              <div
                class="text-2xl font-mono font-bold text-cyber-green"
                id="sidebar-stat-analyzed"
              >
                0
              </div>
              <div
                class="text-[10px] text-gray-500 uppercase tracking-widest mt-1"
              >
                Analyzed
              </div>
            </div>
          </div>
          <div class="flex justify-between text-xs font-mono text-gray-500">
            <span class="flex items-center gap-1"
              >PENDING:
              <span id="sidebar-stat-pending" class="text-cyber-magenta"
                >0</span
              ></span
            >
            <span class="flex items-center gap-1"
              >STARS:
              <span id="sidebar-stat-stars" class="text-white">0</span></span
            >
          </div>
        </div>

        <!-- Nav Items -->
        <div class="flex-1 overflow-y-auto p-4 space-y-1 hide-scrollbar">
          <div
            class="text-[10px] font-mono text-gray-600 uppercase tracking-widest mb-3 pl-2"
          >
            System Modules
          </div>

          <div
            class="category-item p-2 rounded-sm cursor-pointer flex items-center gap-3 text-sm text-gray-400"
            onclick="
              switchTab('view-search');
              handleChatSubmit('conversational', 'Help me find a project');
            "
          >
            <span class="material-icons-round text-cyber-magenta"
              >psychology</span
            >
            AI_ASSISTANT
          </div>
          <div
            class="category-item p-2 rounded-sm cursor-pointer flex items-center gap-3 text-sm text-gray-400"
            onclick="
              switchTab('view-search');
              showSourceBoard();
              loadNewsSources();
            "
          >
            <span class="material-icons-round text-cyber-cyan">public</span>
            NET_DISCOVERY
          </div>

          <div
            class="text-[10px] font-mono text-gray-600 uppercase tracking-widest mt-6 mb-3 pl-2"
          >
            Data Categories
          </div>
          <div id="categories" class="space-y-1">
            <!-- Categories injected via JS -->
          </div>
        </div>

        <!-- Quick Add -->
        <div class="p-4 border-t border-cyber-border">
          <button
            onclick="promptAddProject()"
            class="w-full border border-dashed border-gray-700 text-gray-500 hover:border-cyber-cyan hover:text-cyber-cyan py-2 text-xs font-mono uppercase tracking-widest transition-all"
          >
            + Ingest URL
          </button>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main
        class="flex-1 relative bg-cyber-black overflow-hidden flex flex-col"
      >
        <!-- View: Dashboard -->
        <div
          id="view-dashboard"
          class="view-section flex-1 overflow-y-auto p-8 hide-scrollbar bg-[url('https://transparenttextures.com/patterns/carbon-fibre.png')]"
        >
          <div
            class="flex justify-between items-end mb-6 border-b border-cyber-border pb-4"
          >
            <div>
              <div
                class="text-cyber-cyan font-mono text-xs mb-1 tracking-widest"
              >
                CURRENT SECTOR
              </div>
              <h2
                id="current-category"
                class="text-3xl font-display font-bold text-white uppercase"
              >
                Initializing...
              </h2>
            </div>
            <button
              onclick="refreshCategory()"
              class="text-gray-500 hover:text-white transition-colors"
            >
              <span class="material-icons-round animate-spin-slow">sync</span>
            </button>
          </div>

          <!-- Projects Grid -->
          <div
            id="projects"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
          >
            <!-- Cards injected via JS -->
            <div
              class="col-span-full flex flex-col items-center justify-center py-20 text-gray-600"
            >
              <span class="material-icons-round text-4xl mb-4 animate-spin"
                >hourglass_empty</span
              >
              <span class="font-mono text-sm tracking-widest"
                >ESTABLISHING UPLINK...</span
              >
            </div>
          </div>
        </div>

        <!-- View: Search / Discovery -->
        <div
          id="view-search"
          class="view-section hidden flex-1 overflow-y-auto p-0 flex-col bg-cyber-black"
        >
          <div
            class="flex-0 p-8 border-b border-cyber-border bg-cyber-panel/30"
          >
            <div class="max-w-4xl mx-auto w-full">
              <div class="text-center mb-8">
                <h1
                  class="text-4xl font-bold font-display text-white mb-2 tracking-tight"
                >
                  NEURAL SEARCH 2.0
                </h1>
                <p class="text-gray-500 font-mono text-xs">
                  HYBRID RETRIEVAL // AI REFINEMENT // REAL-TIME INDEXING
                </p>
              </div>

              <!-- Search Box -->
              <div class="relative group">
                <div
                  class="absolute -inset-0.5 bg-gradient-to-r from-cyber-cyan to-cyber-magenta rounded-lg opacity-30 group-hover:opacity-75 transition duration-500 blur"
                ></div>
                <div
                  class="relative flex items-center bg-cyber-black rounded-lg border border-cyber-border p-2"
                >
                  <span class="material-icons-round text-gray-500 ml-3"
                    >terminal</span
                  >
                  <input
                    type="text"
                    id="chat-input"
                    class="w-full bg-transparent border-none text-white font-mono placeholder-gray-700 focus:ring-0 px-4 py-2"
                    placeholder="Enter query parameters or natural language command..."
                    onkeypress="
                      if (event.key === 'Enter') handleChatSubmit('direct');
                    "
                  />

                  <div class="flex gap-2 pr-2">
                    <button
                      onclick="handleChatSubmit('conversational')"
                      class="p-2 text-cyber-magenta hover:bg-cyber-magenta/10 rounded-md transition-colors"
                      title="AI Agent"
                    >
                      <span class="material-icons-round">psychology</span>
                    </button>
                    <button
                      onclick="handleChatSubmit('direct')"
                      class="p-2 text-cyber-cyan hover:bg-cyber-cyan/10 rounded-md transition-colors"
                      title="Direct Search"
                    >
                      <span class="material-icons-round">search</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Chat History -->
              <div
                id="chat-history"
                class="mt-6 space-y-4 max-h-[300px] overflow-y-auto hide-scrollbar font-mono text-sm"
              >
                <div class="flex justify-start">
                  <div
                    class="bg-cyber-panel border border-cyber-border text-gray-400 px-4 py-3 rounded-tr-xl rounded-br-xl rounded-bl-xl max-w-[80%]"
                  >
                    <span class="text-cyber-cyan mr-2">></span> System
                    initialized. Awaiting input.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="search-results-area" class="flex-1 p-8 overflow-y-auto">
            <div class="max-w-6xl mx-auto">
              <!-- Source Board Panel -->
              <div
                id="source-board-panel"
                class="hidden mb-8 bg-cyber-panel/50 border border-cyber-border p-6 rounded-lg"
              >
                <div class="flex justify-between items-center mb-6">
                  <h3
                    class="text-xl font-display font-bold text-white flex items-center gap-2"
                  >
                    <span class="material-icons-round text-cyber-green"
                      >public</span
                    >
                    DISCOVERY NODES
                  </h3>
                  <button
                    onclick="toggleSourceBoard()"
                    class="text-gray-500 hover:text-white"
                  >
                    ‚úï
                  </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                  <div class="flex gap-2">
                    <input
                      type="text"
                      id="new-source-name"
                      placeholder="NODE_ID (Name)"
                      class="bg-cyber-black border border-cyber-border text-white text-xs p-2 rounded-sm w-1/3 placeholder-gray-700 focus:border-cyber-cyan focus:ring-0"
                    />
                    <input
                      type="text"
                      id="new-source-url"
                      placeholder="Protocol Address (URL)"
                      class="bg-cyber-black border border-cyber-border text-white text-xs p-2 rounded-sm flex-1 placeholder-gray-700 focus:border-cyber-cyan focus:ring-0"
                    />
                    <button
                      onclick="addNewsSource()"
                      class="bg-gray-800 hover:bg-cyber-cyan hover:text-black text-white px-3 rounded-sm transition-colors"
                    >
                      +
                    </button>
                  </div>
                  <div class="flex gap-2">
                    <input
                      type="text"
                      id="discovery-url"
                      placeholder="Quick Scan Target URL..."
                      class="bg-cyber-black border border-cyber-border text-white text-xs p-2 rounded-sm flex-1 placeholder-gray-700 focus:border-cyber-cyan focus:ring-0"
                    />
                    <button
                      onclick="scanNewsSource()"
                      class="bg-cyber-dim border border-cyber-border text-cyber-cyan hover:bg-cyber-cyan hover:text-black px-4 text-xs font-mono uppercase rounded-sm transition-colors"
                    >
                      SCAN
                    </button>
                  </div>
                </div>

                <div
                  id="sources-board"
                  class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 max-h-[300px] overflow-y-auto"
                ></div>

                <div
                  id="discovery-results-container"
                  class="hidden border-t border-cyber-border pt-6"
                >
                  <div class="flex items-center gap-2 mb-4">
                    <span class="text-cyber-green font-mono text-sm"
                      >>> NEW SIGNALS DETECTED:</span
                    >
                    <span
                      id="discovery-count"
                      class="bg-cyber-green text-black text-xs font-bold px-2 py-0.5 rounded-sm"
                      >0</span
                    >
                  </div>
                  <div
                    id="discovery-results"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
                  ></div>
                </div>
              </div>

              <!-- Search Results -->
              <div
                id="ai-insight-block"
                class="hidden mb-8 neon-border bg-cyber-panel/80 p-6 rounded-lg"
              ></div>
              <div
                id="results-grid"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
              ></div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Floating Windows -->

    <!-- Agent Window -->
    <div id="agent-window" class="floating-window top-20 right-8 w-96 h-[500px] border-l-4 border-l-cyber-cyan">
        <div class="window-header" id="agent-header">
            <div class="window-title flex items-center gap-2">
                <span class="material-icons-round text-sm animate-pulse">smart_toy</span> 
                AGENT_OP_CENTER <span class="text-[10px] text-gray-500">v2.0</span>
            </div>
            <div class="flex gap-1">
                <button class="win-ctrl min" onclick="toggleWindow('agent-window')"></button>
                <button class="win-ctrl close" onclick="toggleWindow('agent-window')"></button>
            </div>
        </div>
        <div class="p-4 grid grid-cols-2 gap-2 border-b border-cyber-border bg-[#050505] relative">
            <div class="absolute inset-0 bg-cyber-dim pointer-events-none opacity-20" style="background-image: repeating-linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%, #000), repeating-linear-gradient(45deg, #000 25%, #00f0ff 25%, #00f0ff 75%, #000 75%, #000); background-position: 0 0, 10px 10px; background-size: 20px 20px;"></div>
            
            <button onclick="startScan()" class="relative bg-cyber-dark border border-cyber-cyan text-cyber-cyan hover:bg-cyber-cyan hover:text-black text-[10px] font-mono py-2 rounded-sm transition-all group overflow-hidden">
                <span class="relative z-10">FULL_SCAN_SEQ</span>
                <div class="absolute inset-0 bg-cyber-cyan opacity-20 translate-y-full group-hover:translate-y-0 transition-transform"></div>
            </button>
            <button onclick="startBatchAnalysis()" class="relative bg-cyber-dark border border-cyber-magenta text-cyber-magenta hover:bg-cyber-magenta hover:text-black text-[10px] font-mono py-2 rounded-sm transition-all group">
                <span class="relative z-10">BATCH_ANALYZE</span>
            </button>
            <button onclick="triggerNewsScan()" class="bg-gray-900 border border-gray-700 text-gray-400 hover:border-white hover:text-white text-[10px] font-mono py-2 rounded-sm transition-colors">DISCOVERY_PROTO</button>
            <button onclick="openSettings()" class="bg-gray-900 border border-gray-700 text-gray-400 hover:border-white hover:text-white text-[10px] font-mono py-2 rounded-sm transition-colors">SYS_CONFIG</button>
        </div>
        <div class="flex-1 overflow-y-auto p-0 bg-[#08080a] relative">
             <div class="absolute inset-0 pointer-events-none scanlines z-10 opacity-30"></div>
             <!-- Agents List -->
        <div
          id="agent-master"
          class="p-4 border-b border-cyber-border flex items-center gap-4 transition-colors"
        >
          <div
            class="w-10 h-10 bg-cyber-panel border border-cyber-border rounded flex items-center justify-center text-xl"
          >
            üëë
          </div>
          <div class="flex-1">
            <div class="text-sm font-bold text-white font-display">
              MASTER_CONTROL
            </div>
            <div class="text-xs font-mono text-gray-600 agent-status">IDLE</div>
          </div>
          <div
            class="w-2 h-2 rounded-full bg-gray-800 active-indicator transition-colors"
          ></div>
        </div>

        <div
          id="agent-crawler"
          class="p-4 border-b border-cyber-border flex items-center gap-4 transition-colors"
        >
          <div
            class="w-10 h-10 bg-cyber-panel border border-cyber-border rounded flex items-center justify-center text-xl"
          >
            üï∑Ô∏è
          </div>
          <div class="flex-1">
            <div class="text-sm font-bold text-white font-display">
              CRAWLER_UNIT
            </div>
            <div class="text-xs font-mono text-gray-600 agent-status">IDLE</div>
          </div>
        </div>

        <div
          id="agent-analyzer"
          class="p-4 border-b border-cyber-border flex items-center gap-4 transition-colors"
        >
          <div
            class="w-10 h-10 bg-cyber-panel border border-cyber-border rounded flex items-center justify-center text-xl"
          >
            üß†
          </div>
          <div class="flex-1">
            <div class="text-sm font-bold text-white font-display">
              NEURAL_ANALYZER
            </div>
            <div class="text-xs font-mono text-gray-600 agent-status">IDLE</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Terminal Window -->
    <div id="terminal-window" class="floating-window bottom-8 right-8 w-[600px] h-[350px] border-l-4 border-l-cyber-magenta">
        <div class="window-header" id="terminal-header">
            <div class="window-title flex items-center gap-2">
                <span class="material-icons-round text-sm text-cyber-magenta">terminal</span> 
                SYSTEM_LOG <span class="animate-pulse">_</span>
            </div>
            <div class="flex gap-1">
                <button class="win-ctrl min" onclick="toggleWindow('terminal-window')"></button>
                <button class="win-ctrl close" onclick="toggleWindow('terminal-window')"></button>
            </div>
        </div>
        <div id="terminal-content" class="flex-1 bg-[#050505] p-4 overflow-y-auto font-mono text-[11px] text-gray-400 space-y-1 relative">
            <div class="absolute inset-0 pointer-events-none scanlines z-10 opacity-20"></div>
            <!-- Logs go here -->
            <div class="log-entry relative z-20"><span class="text-gray-600">[SYSTEM]</span> <span class="text-cyber-cyan">Interface initialized. Link established.</span></div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Tutorial Modal -->
    <!-- Tutorial/Summary Window (Restored as Floating Window) -->
    <div id="tutorial-modal" class="floating-window top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[600px] border-l-4 border-l-cyber-magenta">
        <div class="window-header">
            <div class="window-title flex items-center gap-2">
                <span class="material-icons-round text-sm text-cyber-magenta">library_books</span> 
                <span id="modal-title">ANALYSIS_MATRIX</span>
            </div>
            <div class="flex gap-1">
                <button class="win-ctrl min" onclick="closeModal()"></button>
                <button class="win-ctrl close" onclick="closeModal()"></button>
            </div>
        </div>
        <div id="tutorial-content" class="flex-1 bg-[#050505] p-8 overflow-y-auto leading-relaxed markdown-content relative">
            <div class="absolute inset-0 pointer-events-none scanlines z-10 opacity-10"></div>
            <!-- Content Injected Here -->
        </div>
    </div>

    <!-- Settings Modal -->
    <div
      id="settings-modal"
      class="modal fixed inset-0 z-50 hidden flex items-center justify-center"
      onclick="closeSettingsIfOutside(event)"
    >
      <div class="modal-content w-[400px] rounded-lg overflow-hidden p-6">
        <h2
          class="text-xl font-display font-bold text-white mb-6 border-b border-cyber-border pb-2"
        >
          SYSTEM CONFIG
        </h2>
        <div class="mb-6">
          <label class="text-xs font-mono text-cyber-cyan mb-2 block uppercase"
            >Auto-Scan Schedule</label
          >
          <input
            type="time"
            id="setting-scan-time"
            class="w-full bg-cyber-black border border-cyber-border text-white rounded p-2 focus:ring-1 focus:ring-cyber-cyan focus:border-cyber-cyan outline-none"
          />
        </div>
        <button
          onclick="saveSettings()"
          class="w-full bg-cyber-cyan text-black font-bold font-mono py-2 rounded-sm hover:bg-cyan-400 transition-colors"
        >
          SAVE_CONFIG
        </button>
      </div>
    </div>

    <!-- Search Modal (Legacy, mapped to view-search but kept for existing JS compatibility calls) -->
    <div id="search-modal" class="hidden"></div>


    <!-- Hover Summary Tooltip -->
    <div id="hover-summary-tooltip"></div>

    <!-- Javascript Logic Preserved -->
    <script>
      const API = "";
      const isReadOnly = !["localhost", "127.0.0.1"].includes(
        window.location.hostname,
      );
      let currentCategory = null;
      const chatHistory = [];
      let isSearching = false;

      // --- Core UI Functions ---

      function toggleSidebar() {
        const sidebar = document.getElementById("main-sidebar");
        if (sidebar.classList.contains("-translate-x-full")) {
          sidebar.classList.remove(
            "-translate-x-full",
            "w-0",
            "p-0",
            "overflow-hidden",
          );
          sidebar.classList.add("w-64");
        } else {
          if (sidebar.classList.contains("w-64")) {
            sidebar.classList.remove("w-64");
            sidebar.classList.add("w-0", "p-0", "overflow-hidden");
          } else {
            // Initial toggle logic if classes vary
            sidebar.classList.toggle("hidden");
          }
        }
      }

      // Simpler toggle for the Tailwind sidebar
      document.getElementById("main-sidebar").style.transition =
        "width 0.3s ease, padding 0.3s ease";
      // Redefine to work with the specific style
      window.toggleSidebar = function () {
        const sb = document.getElementById("main-sidebar");
        if (sb.style.width === "0px") {
          sb.style.width = "16rem"; // w-64
        } else {
          sb.style.width = "0px";
        }
      };

      function switchTab(tab) {
        document
          .querySelectorAll(".view-section")
          .forEach((el) => el.classList.add("hidden"));
        document.getElementById(tab).classList.remove("hidden");
      }

      function toggleWindow(id) {
        document.getElementById(id).classList.toggle("active");
        // Z-index handling
        document
          .querySelectorAll(".floating-window")
          .forEach((w) => (w.style.zIndex = 50));
        document.getElementById(id).style.zIndex = 51;
      }

      function toggleSourceBoard() {
        const panel = document.getElementById("source-board-panel");
        panel.classList.toggle("hidden");
      }

      function showSourceBoard() {
        document
          .getElementById("source-board-panel")
          .classList.remove("hidden");
      }

      function toggleManageMode() {
        document.body.classList.toggle("manage-mode");
        document
          .getElementById("btn-manage")
          .classList.toggle("text-cyber-magenta");
        document.getElementById("btn-manage").classList.toggle("text-gray-400");
      }

      function openSettings() {
        document.getElementById("settings-modal").classList.remove("hidden");
        loadSettings();
      }
      function closeSettings() {
        document.getElementById("settings-modal").classList.add("hidden");
      }
      function closeSettingsIfOutside(e) {
        if (e.target.id === "settings-modal") closeSettings();
      }

      async function loadSettings() {
        try {
          const res = await fetch(`${API}/api/settings`);
          const data = await res.json();
          document.getElementById("setting-scan-time").value =
            data.scan_time || "02:00";
        } catch (e) {
          console.error(e);
        }
      }

      async function saveSettings() {
        const time = document.getElementById("setting-scan-time").value;
        try {
          await fetch(`${API}/api/settings`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ scan_time: time }),
          });
          addLog(`Config updated: Auto-scan at ${time}`, "success");
          closeSettings();
        } catch (e) {
          alert("Failed to save settings");
        }
      }

      // --- Data Loading & Rendering ---

      async function loadCategories() {
        try {
          const res = await fetch(`${API}/api/categories`);
          const categories = await res.json();
          const container = document.getElementById("categories");

          container.innerHTML = Object.entries(categories)
            .map(
              ([id, cat]) => `
                    <div class="category-item p-2 rounded-sm cursor-pointer flex items-center justify-between text-sm text-gray-400 font-mono" id="cat-item-${id}" onclick="selectCategory('${id}')">
                        <span class="flex items-center gap-2"><span class="text-xs text-gray-600">#</span> ${cat.name}</span>
                        <span class="text-[10px] bg-cyber-panel px-1.5 py-0.5 rounded text-gray-500" id="count-${id}">...</span>
                    </div>
                `,
            )
            .join("");

          const keys = Object.keys(categories);
          if (keys.includes("trending")) selectCategory("trending");
          else if (keys.length) selectCategory(keys[0]);
          
          // Async fetch counts & calc analyzed stats
          const tutorialIds = new Set();
          for (const id of keys) {
               fetch(`${API}/api/projects/${id}?limit=1000`)
                .then(r => r.json())
                .then(data => {
                    const el = document.getElementById(`count-${id}`);
                    if(el) el.textContent = data.length || 0;
                    
                    // Count with tutorials
                    data.forEach(p => {
                        if (p.ai_tutorial) tutorialIds.add(p.id);
                    });
                    // Update global stat
                    document.getElementById("sidebar-stat-analyzed").textContent = tutorialIds.size;
                }).catch(() => {});
          }

          loadStats();
        } catch (e) {
          console.error(e);
          addLog("Init Error: " + e.message, "error");
        }
      }

      async function selectCategory(category) {
        currentCategory = category;
        switchTab("view-dashboard"); // Force switch to dashboard
        document
          .querySelectorAll(".category-item")
          .forEach((el) => el.classList.remove("active"));
        const activeEl = document.getElementById(`cat-item-${category}`);
        if (activeEl) activeEl.classList.add("active");

        const container = document.getElementById("projects");
        container.innerHTML =
          '<div class="col-span-full flex justify-center py-20"><div class="animate-spin text-cyber-cyan material-icons-round text-4xl">data_usage</div></div>';

        // Update Title
        const catRes = await fetch(`${API}/api/categories`);
        const cats = await catRes.json();
        document.getElementById("current-category").textContent =
          cats[category]?.name || category;

        try {
          const res = await fetch(`${API}/api/projects/${category}`);
          const projects = await res.json();

          if (!projects.length) {
            container.innerHTML =
              '<div class="col-span-full text-center text-gray-600 font-mono py-10">NO SIGNAL DETECTED.<br>Use "Ingest URL" to add data nodes.</div>';
            return;
          }

          container.innerHTML = projects
            .map((p) => renderProjectCard(p))
            .join("");
        } catch (e) {
          container.innerHTML = `<div class="col-span-full text-red-500 font-mono">ERROR: ${e.message}</div>`;
        }
      }

      function renderProjectCard(p) {
        let tags = p.ai_tags || p.topics || [];
        if (typeof tags === "string")
          try {
            tags = JSON.parse(tags);
          } catch {
            tags = [];
          }
        tags = [...new Set(tags)].slice(0, 3);

        const is120b =
          p.ai_model_name && p.ai_model_name.toLowerCase().includes("120b");
        const isAnalyzed = !!p.ai_summary && is120b;
        const hasTutorial = !!p.ai_tutorial;
        const summaryText = (p.ai_summary || p.description || "No description available.").replace(/"/g, '&quot;').replace(/'/g, "&#39;");
        const topicsJson = JSON.stringify(tags).replace(/"/g, '&quot;');

        // Language Color
        const langColors = {
          Python: "#3572A5",
          JavaScript: "#f1e05a",
          TypeScript: "#3178c6",
          Java: "#b07219",
          Go: "#00ADD8",
          Rust: "#dea584",
        };
        const langColor = langColors[p.language] || "#666";

        return `
                <div class="group relative bg-[#18181b]/80 border border-cyber-border rounded-lg overflow-hidden transition-all hover:-translate-y-1 hover:border-cyber-cyan hover:shadow-neon-cyan/20 backdrop-blur-sm cursor-pointer"
                     onclick="window.open('${p.url}', '_blank')"
                     onmouseenter="showTooltip(event, '${(p.name || "Unknown").replace(/'/g, "\\'")}', '${p.language || "N/A"}', '${summaryText}', '${topicsJson}')"
                     onmouseleave="hideTooltip()">
                    
                    ${isAnalyzed ? `<div class="absolute top-2 right-2 z-20 bg-cyber-green text-black text-[10px] font-bold px-2 py-0.5 rounded-sm shadow-neon-green flex items-center gap-1"><span>‚ú®</span> 120B</div>` : ""}
                    <button class="absolute top-2 left-2 z-20 bg-red-500/80 text-white w-6 h-6 rounded-full items-center justify-center hidden group-hover:block" onclick="event.stopPropagation(); deleteProject('${p.id}')">‚úï</button>
                    
                    <div class="p-5 h-full flex flex-col">
                        <div class="flex items-start justify-between mb-3">
                             <h3 class="font-mono font-bold text-lg text-white group-hover:text-cyber-cyan truncate pr-2 w-full">${p.name}</h3>
                        </div>
                        
                        <p class="text-xs text-gray-400 mb-4 line-clamp-3 leading-relaxed flex-1 font-sans">
                            ${p.ai_summary || p.description || "No description available."}
                        </p>
                        
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${tags.map((t) => `<span class="text-[10px] font-mono border border-cyber-border text-gray-500 px-2 py-0.5 rounded hover:border-cyber-cyan hover:text-cyber-cyan transition-colors" onclick="event.stopPropagation(); searchByTag('${t}')">${t}</span>`).join("")}
                        </div>
                        
                        <div class="flex items-center justify-between pt-3 border-t border-cyber-border/50 text-xs font-mono text-gray-500">
                             <div class="flex items-center gap-1.5">
                                 <span class="w-2 h-2 rounded-full" style="background:${langColor}"></span>
                                 ${p.language || "N/A"}
                             </div>
                             <div class="flex items-center gap-3">
                                 <span class="flex items-center gap-1">‚≠ê ${formatNumber(p.stars)}</span>
                                 ${hasTutorial ? 
                                    `<button onclick="event.stopPropagation(); showTutorial('${p.id}', '${(p.name || "").replace(/'/g, "\\'")}')" class="bg-cyber-magenta/20 hover:bg-cyber-magenta text-cyber-magenta hover:text-white px-2 py-0.5 rounded text-[10px] font-bold transition-colors flex items-center gap-1"><span class="material-icons-round text-[10px]">school</span> TUTORIAL</button>` 
                                    : `<span class="flex items-center gap-1">üç¥ ${formatNumber(p.forks)}</span>`
                                 }
                             </div>
                        </div>
                    </div>
                    
                    <!-- Hover Scanline Overlay -->
                    <div class="absolute inset-0 bg-cyber-cyan/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none scanlines"></div>
                </div>
             `;
      }

      // --- Tooltip Logic ---
      function showTooltip(e, name, lang, summary, topicsStr) {
          const t = document.getElementById("hover-summary-tooltip");
          
          let topicsOps = "";
          try {
             const tops = JSON.parse(topicsStr);
             topicsOps = tops.slice(0, 3).map(tag => `<span class="text-cyber-magenta">#${tag}</span>`).join(" ");
          } catch(e) {}

          t.innerHTML = `
            <div class="flex justify-between items-center border-b border-cyber-border pb-2 mb-2">
                <span class="text-cyber-cyan font-bold text-sm tracking-wide">${name}</span>
                <span class="text-[10px] bg-cyber-border px-1 rounded text-gray-400">${lang}</span>
            </div>
            <div class="text-xs text-gray-300 leading-relaxed font-sans mb-3">
                ${summary.length > 200 ? summary.substring(0, 200) + "..." : summary}
            </div>
            <div class="text-[10px] font-mono flex gap-2">
                ${topicsOps}
            </div>
          `;
          
          t.style.display = "block";
          moveTooltip(e);
      }
      
      function moveTooltip(e) {
          const t = document.getElementById("hover-summary-tooltip");
          if(t.style.display === 'block') {
             // Offset to not cover cursor
             const x = e.clientX + 20; 
             const y = e.clientY + 20;
             
             // Boundary check
             const rect = t.getBoundingClientRect();
             const winW = window.innerWidth;
             const winH = window.innerHeight;
             
             let finalX = x;
             let finalY = y;
             
             if (x + rect.width > winW) finalX = e.clientX - rect.width - 10;
             if (y + rect.height > winH) finalY = e.clientY - rect.height - 10;
             
             t.style.left = finalX + "px";
             t.style.top = finalY + "px";
          }
      }

      function hideTooltip() {
          document.getElementById("hover-summary-tooltip").style.display = "none";
      }
      
      // Attach move listener globally for smoother tracking when active
      document.addEventListener('mousemove', moveTooltip);

      // --- Search & Chat ---

      function searchByTag(tag) {
        switchTab("view-search");
        handleChatSubmit("direct", tag);
      }

      function appendChat(role, text) {
        const historyDiv = document.getElementById("chat-history");
        const isUser = role === "user";

        const html = `
                <div class="flex w-full ${isUser ? "justify-end" : "justify-start"}">
                    <div class="${isUser ? "bg-cyber-dim border-cyber-cyan text-cyber-cyan" : "bg-cyber-panel border-gray-700 text-gray-300"} border px-4 py-3 rounded-lg max-w-[80%] font-mono text-sm shadow-lg mb-2">
                        ${isUser ? "" : '<span class="text-cyber-green mr-2">></span>'}
                        ${typeof marked !== "undefined" && !isUser ? marked.parse(text) : text}
                    </div>
                </div>
            `;
        historyDiv.insertAdjacentHTML("beforeend", html);
        historyDiv.scrollTop = historyDiv.scrollHeight;
        chatHistory.push({ role, content: text });
      }

      async function handleChatSubmit(
        mode = "conversational",
        manualText = null,
      ) {
        const input = document.getElementById("chat-input");
        const text = manualText || input.value.trim();
        if (!text) return;
        if (!manualText) input.value = "";

        appendChat("user", text);

        if (mode === "direct") {
          performHybridSearch(text);
          return;
        }

        // Conversational logic
        const id = "typing-" + Date.now();
        document
          .getElementById("chat-history")
          .insertAdjacentHTML(
            "beforeend",
            `<div id="${id}" class="text-gray-600 text-xs font-mono animate-pulse ml-2">AGI_THINKING...</div>`,
          );

        try {
          const res = await fetch(`${API}/api/agent/refine`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ history: chatHistory }),
          });
          const data = await res.json();
          document.getElementById(id).remove();

          if (data.action === "question") {
            appendChat("assistant", data.content);
          } else {
            appendChat(
              "assistant",
              `Target Identified. Executing Search: **${data.content}**`,
            );
            performHybridSearch(data.content);
          }
        } catch (e) {
          document.getElementById(id).innerHTML = "ERR: LINK_LOST";
        }
      }

      async function performHybridSearch(query) {
        const insight = document.getElementById("ai-insight-block");
        const grid = document.getElementById("results-grid");

        grid.innerHTML = "";
        insight.classList.remove("hidden");
        insight.innerHTML = `<div class="flex items-center gap-3 text-cyber-cyan font-mono"><span class="animate-spin material-icons-round">radar</span> SCANNING LOCAL & REMOTE NODES...</div>`;

        let allProjects = [];
        isSearching = true;
        const ids = new Set();

        function renderBatch(projects) {
          const newP = projects.filter((p) => !ids.has(p.id));
          newP.forEach((p) => ids.add(p.id));
          allProjects = [...allProjects, ...newP];
          if (newP.length)
            grid.insertAdjacentHTML(
              "beforeend",
              newP.map((p) => renderProjectCard(p)).join(""),
            );
          insight.innerHTML = `<div class="font-mono text-sm text-gray-400">NODES FOUND: <span class="text-cyber-green">${allProjects.length}</span> // AWAITING NEURAL ANALYSIS...</div>`;
        }

        // 1. Local
        fetch(`${API}/api/search/local`, {
          method: "POST",
          body: JSON.stringify({ query }),
          headers: { "Content-Type": "application/json" },
        })
          .then((r) => r.json())
          .then((d) => renderBatch(d.results));

        // 2. Remote
        fetch(`${API}/api/search/remote`, {
          method: "POST",
          body: JSON.stringify({ query }),
          headers: { "Content-Type": "application/json" },
        })
          .then((r) => r.json())
          .then((d) => {
            renderBatch(d.results);
            // 3. Recommendation
            if (allProjects.length)
              return fetch(`${API}/api/search/recommend`, {
                method: "POST",
                body: JSON.stringify({
                  query,
                  projects: allProjects.slice(0, 10),
                }),
                headers: { "Content-Type": "application/json" },
              });
          })
          .then((r) => (r ? r.json() : null))
          .then((d) => {
            if (d && d.recommendation) {
              insight.innerHTML = `
                            <div class="flex items-center gap-2 mb-2 text-cyber-magenta font-bold font-display uppercase tracking-wider"><span class="material-icons-round">psychology</span> Neural Insight</div>
                            <div class="markdown-content text-sm text-gray-300">${marked.parse(d.recommendation)}</div>
                        `;
            }
          })
          .finally(() => (isSearching = false));
      }

      // --- Actions & Helpers ---

      async function deleteProject(id) {
        if (!confirm("CONFIRM DELETION: Isolate and purge this node?")) return;
        await fetch(`/api/project/delete/${id}`, { method: "DELETE" });
        if (currentCategory) selectCategory(currentCategory);
      }

      async function promptAddProject() {
        const url = prompt("INPUT TARGET URL:");
        if (!url) return;
        addLog(`Ingesting ${url}...`, "info");
        const res = await fetch("/api/project/add", {
          method: "POST",
          body: JSON.stringify({ url }),
          headers: { "Content-Type": "application/json" },
        });
        const data = await res.json();
        if (data.error) alert(data.error);
        else {
          addLog(`Node added: ${data.project}`, "success");
          if (currentCategory) selectCategory(currentCategory);
        }
      }

      async function createTutorial(id, name) {
        /* Logic handled in showTutorial */
      }

      async function showTutorial(id, name) {
        const modal = document.getElementById("tutorial-modal");
        const title = document.getElementById("modal-title");
        const content = document.getElementById("tutorial-content");

        // Force open - simpler logic
        modal.classList.add("active");
        // Ensure z-index is top
        modal.style.zIndex = 1000;
        
        title.textContent = "ANALYSIS_MATRIX: " + name;
        
        // Loading State
        content.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-cyber-cyan">
                    <span class="material-icons-round text-5xl animate-spin mb-4">donut_large</span>
                    <div class="font-mono text-lg animate-pulse">DECRYPTING TUTORIAL DATA...</div>
                    <div class="text-xs text-gray-500 mt-2 font-mono">MODEL: Qwen-Max // LAYER: Pedagogical Extraction</div>
                </div>
            `;
            
        try {
            const res = await fetch(`${API}/api/project/${id}`);
            const p = await res.json();
            
            if (p.ai_tutorial) {
                 content.innerHTML = `
                    <div class="markdown-content text-sm text-gray-300 font-sans leading-relaxed">
                        ${marked.parse(p.ai_tutorial)}
                    </div>
                 `;
            } else {
                 content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-gray-500 font-mono">
                        <span class="material-icons-round text-4xl mb-4">no_sim</span>
                        <div>NO TUTORIAL DATA FOUND</div>
                    </div>
                 `;
            }
        } catch(e) {
             content.innerHTML = `<div class="text-red-500 font-mono">ERROR: ${e.message}</div>`;
        }
      }
      function closeModal() {
        document.getElementById("tutorial-modal").classList.remove("active");
      }

      async function startScan() {
        await fetch(`${API}/api/scan`, { method: "POST" });
        addLog("SCAN_SEQUENCE_INITIATED", "info");
        toggleWindow("terminal-window");
      }

      async function startBatchAnalysis() {
        if (!confirm("INITIATE BATCH ANALYSIS? Heavy compute load expected."))
          return;
        await fetch("/api/analyze_all", { method: "POST" });
        document.getElementById("progress-container").style.display = "block";
        startPolling();
      }

      let poolInt;
      function startPolling() {
        poolInt = setInterval(async () => {
          const r = await fetch("/api/progress");
          const d = await r.json();
          if (d.done < d.total) {
            document.getElementById("progress-container").style.display =
              "block";
            document.getElementById("progress-bar").style.width =
              (d.done / d.total) * 100 + "%";
            document.getElementById("progress-text").textContent =
              `${d.done}/${d.total}`;
          } else {
            document.getElementById("progress-container").style.display =
              "none";
            clearInterval(poolInt);
            loadStats();
          }
        }, 1500);
      }

      async function loadStats() {
        const [s, p] = await Promise.all([
          fetch(`${API}/api/stats`).then((r) => r.json()),
          fetch(`${API}/api/pending`).then((r) => r.json()),
        ]);
        document.getElementById("sidebar-stat-total").textContent =
          s.total_projects;
        // Analyzed count is now handled by loadCategories filtering for tutorials
        // document.getElementById("sidebar-stat-analyzed").textContent = s.analyzed_projects; 
        document.getElementById("sidebar-stat-stars").textContent =
          formatNumber(s.total_stars);
        document.getElementById("sidebar-stat-pending").textContent = p.pending;
      }

      function addLog(msg, type) {
        const t = document.getElementById("terminal-content");
        const colors = {
          info: "text-cyber-cyan",
          success: "text-cyber-green",
          error: "text-red-500",
          warning: "text-yellow-500",
        };
        const time = new Date().toLocaleTimeString();
        const html = `
                <div class="log-entry font-mono text-[10px] flex gap-2">
                    <span class="text-gray-600">[${time}]</span>
                    <span class="${colors[type] || "text-white"}">${msg}</span>
                </div>
            `;
        t.insertAdjacentHTML("beforeend", html);
        t.scrollTop = t.scrollHeight;
      }

      function formatNumber(n) {
        if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
        if (n >= 1000) return (n / 1000).toFixed(1) + "K";
        return n;
      }

      // Draggable
      function makeDraggable(el) {
        const h = el.querySelector(".window-header");
        let isDown = false,
          offset = [0, 0];
        h.addEventListener("mousedown", (e) => {
          isDown = true;
          offset = [el.offsetLeft - e.clientX, el.offsetTop - e.clientY];
          el.style.zIndex = 100;
        });
        document.addEventListener("mouseup", () => (isDown = false));
        document.addEventListener("mousemove", (e) => {
          if (!isDown) return;
          el.style.left = e.clientX + offset[0] + "px";
          el.style.top = e.clientY + offset[1] + "px";
        });
      }
      document.querySelectorAll(".floating-window").forEach(makeDraggable);

      // News Sources (Stubbed for brevity but logic is same)
      async function loadNewsSources() {
        const r = await fetch(`${API}/api/news/sources`);
        const d = await r.json();
        const b = document.getElementById("sources-board");
        if (!d.sources.length)
          b.innerHTML =
            '<div class="col-span-full text-center text-gray-700 font-mono py-10">NO SIGNAL SOURCES DETECTED</div>';
        else
          b.innerHTML = d.sources
            .map(
              (s) => `
                <div class="bg-cyber-black border border-cyber-border p-3 rounded-sm flex flex-col gap-2">
                    <div class="flex justify-between items-start">
                        <div class="text-white font-bold text-sm truncate">${s.name}</div>
                        <button onclick="deleteNewsSource(${s.id})" class="text-red-900 hover:text-red-500">‚úï</button>
                    </div>
                    <div class="text-[10px] text-cyber-cyan truncate">${s.url}</div>
                    <button onclick="scanSavedSource(${s.id}, this)" class="mt-2 bg-cyber-dim hover:bg-cyber-cyan hover:text-black text-cyber-cyan text-xs py-1 rounded-sm transition-colors uppercase font-mono">Initiate Scan</button>
                </div>
             `,
            )
            .join("");
      }

      async function addNewsSource() {
        const name = document.getElementById("new-source-name").value;
        const url = document.getElementById("new-source-url").value;
        if (!name || !url) return;
        await fetch(`${API}/api/news/sources/add`, {
          method: "POST",
          body: JSON.stringify({ name, url }),
          headers: { "Content-Type": "application/json" },
        });
        loadNewsSources();
        document.getElementById("new-source-name").value = "";
        document.getElementById("new-source-url").value = "";
      }

      async function deleteNewsSource(id) {
        if (!confirm("Purge Source Node?")) return;
        await fetch(`${API}/api/news/sources/delete/${id}`, {
          method: "DELETE",
        });
        loadNewsSources();
      }

      async function scanSavedSource(id, btn) {
        btn.textContent = "scanning...";
        const r = await fetch(`${API}/api/news/sources/scan/${id}`, {
          method: "POST",
        });
        const d = await r.json();
        btn.textContent = "Done";
        if (d.results.length) {
          const c = document.getElementById("discovery-results-container");
          c.classList.remove("hidden");
          document.getElementById("discovery-results").innerHTML = d.results
            .map((p) => renderProjectCard(p))
            .join("");
        }
      }

      async function scanNewsSource() {
        const url = document.getElementById("discovery-url").value;
        if (!url) return;
        const r = await fetch(`${API}/api/news/scan`, {
          method: "POST",
          body: JSON.stringify({ url }),
          headers: { "Content-Type": "application/json" },
        });
        const d = await r.json();
        const c = document.getElementById("discovery-results-container");
        c.classList.remove("hidden");
        document.getElementById("discovery-results").innerHTML = d.results
          .map((p) => renderProjectCard(p))
          .join("");
        document.getElementById("discovery-count").textContent =
          d.results.length;
      }

      // Init
      loadCategories();
      // SSE
      const evt = new EventSource(`${API}/api/logs`);
      evt.onmessage = (e) => {
        const d = JSON.parse(e.data);
        if (d.level !== "ping") {
          addLog(d.message, d.level);
          // Simple status update for agents
          const t = d.message;
          if (t.includes("Crawling"))
            document.querySelector("#agent-crawler .agent-status").textContent =
              "ACTIVE";
          if (t.includes("Analyzing"))
            document.querySelector(
              "#agent-analyzer .agent-status",
            ).textContent = "COMPUTING";
          setTimeout(() => {
            document.querySelector("#agent-crawler .agent-status").textContent =
              "IDLE";
            document.querySelector(
              "#agent-analyzer .agent-status",
            ).textContent = "IDLE";
          }, 5000);
        }
      };
    </script>
  </body>
</html>
